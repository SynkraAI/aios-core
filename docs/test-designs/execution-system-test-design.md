# Test Design: Execution System Core Module

**Generated:** 2026-02-05
**Generated By:** @qa (Quinn)
**Task:** *test-design
**Module:** `.aios-core/core/execution/`
**Scope:** 10 source files, 9 untested (90% gap)

---

## Coverage Summary

| File | Lines | Has Tests | Priority | Est. Scenarios |
|------|-------|-----------|----------|----------------|
| `build-orchestrator.js` | 1055 | No | P0 | 28 |
| `wave-executor.js` | 398 | No | P0 | 18 |
| `autonomous-build-loop.js` | 1067 | No | P0 | 24 |
| `build-state-manager.js` | 1530 | **Yes (38)** | -- | Covered |
| `semantic-merge-engine.js` | 1736 | No | P1 | 32 |
| `context-injector.js` | 537 | No | P1 | 16 |
| `result-aggregator.js` | 486 | No | P1 | 20 |
| `rate-limit-manager.js` | 315 | No | P2 | 14 |
| `parallel-monitor.js` | 430 | No | P2 | 16 |
| `subagent-dispatcher.js` | 522 | No | P2 | 22 |

**Total New Scenarios:** 190
**Existing Coverage:** 38 tests (build-state-manager only)

---

## Test Files to Create

| Test File | Source File | Location |
|-----------|------------|----------|
| `build-orchestrator.test.js` | `build-orchestrator.js` | `tests/core/` |
| `wave-executor.test.js` | `wave-executor.js` | `tests/core/` |
| `autonomous-build-loop.test.js` | `autonomous-build-loop.js` | `tests/core/` |
| `semantic-merge-engine.test.js` | `semantic-merge-engine.js` | `tests/core/` |
| `context-injector.test.js` | `context-injector.js` | `tests/core/` |
| `result-aggregator.test.js` | `result-aggregator.js` | `tests/core/` |
| `rate-limit-manager.test.js` | `rate-limit-manager.js` | `tests/core/` |
| `parallel-monitor.test.js` | `parallel-monitor.js` | `tests/core/` |
| `subagent-dispatcher.test.js` | `subagent-dispatcher.js` | `tests/core/` |

---

## 1. BuildOrchestrator (`build-orchestrator.js`) - P0

**Class:** `BuildOrchestrator extends EventEmitter`
**Key exports:** `BuildOrchestrator, OrchestratorEvent, Phase, DEFAULT_CONFIG`
**Dependencies:** `AutonomousBuildLoop`, `BuildStateManager`, `WorktreeManager` (optional), `GotchasMemory` (optional)

### 1.1 Constructor & Configuration

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| BO-01 | Create with default config | Unit | P0 | All defaults applied, no errors |
| BO-02 | Create with custom config (maxIterations, timeout) | Unit | P1 | Custom values override defaults |
| BO-03 | Create with missing optional dependencies (no WorktreeManager) | Unit | P1 | Graceful fallback, no throws |
| BO-04 | Verify OrchestratorEvent enum values | Unit | P2 | All event names present and correct |
| BO-05 | Verify Phase enum values | Unit | P2 | All 8 phases defined correctly |

### 1.2 Build Pipeline (`build()`)

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| BO-06 | Full build happy path (all 8 phases pass) | Integration | P0 | Returns success result with report |
| BO-07 | Build with phase failure at init | Unit | P0 | Emits failure event, returns error result |
| BO-08 | Build with phase failure at execute | Unit | P0 | Skips remaining phases, runs cleanup |
| BO-09 | Build with story file not found | Unit | P1 | Appropriate error message |
| BO-10 | Build emits correct events per phase | Unit | P0 | phase_started, phase_completed for each |
| BO-11 | Build respects global timeout | Unit | P1 | Aborts and reports timeout error |

### 1.3 Phase Methods

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| BO-12 | `phaseInit` - creates state, loads plan | Unit | P0 | State exists, plan loaded |
| BO-13 | `phaseInit` - resume from existing state | Unit | P1 | Resumes from last checkpoint |
| BO-14 | `phasePlan` - generates valid plan from story | Unit | P1 | Plan has subtasks array |
| BO-15 | `phaseExecute` - delegates to AutonomousBuildLoop | Unit | P0 | Loop.run() called with correct args |
| BO-16 | `phaseQA` - runs verification checks | Unit | P1 | QA result returned |
| BO-17 | `phaseMerge` - handles merge with worktree | Unit | P1 | Files merged to main |
| BO-18 | `phaseMerge` - works without worktree manager | Unit | P1 | Skips merge gracefully |
| BO-19 | `phaseCleanup` - removes temp resources | Unit | P2 | Cleanup completed |
| BO-20 | `phaseReport` - generates final report | Unit | P2 | Report file created |

### 1.4 Utility Methods

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| BO-21 | `buildSubtaskPrompt` - formats prompt with context | Unit | P1 | Prompt contains task ID and description |
| BO-22 | `validateSubtaskResult` - validates success result | Unit | P1 | Returns true for valid output |
| BO-23 | `validateSubtaskResult` - rejects empty result | Unit | P1 | Returns false |
| BO-24 | `extractModifiedFiles` - extracts from output | Unit | P1 | Returns array of file paths |
| BO-25 | `findStoryFile` - locates story by ID | Unit | P2 | Returns correct file path |
| BO-26 | `generatePlan` - creates plan from story content | Unit | P1 | Plan has phases and subtasks |
| BO-27 | `formatDuration` - formats milliseconds | Unit | P2 | Correct human-readable format |
| BO-28 | `runPhase` - wraps phase in event emission | Unit | P0 | Events emitted, errors caught |

---

## 2. WaveExecutor (`wave-executor.js`) - P0

**Class:** `WaveExecutor extends EventEmitter`
**Key exports:** `WaveExecutor`
**Dependencies:** `WaveAnalyzer` (optional), `RateLimitManager` (optional)

### 2.1 Constructor & Configuration

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| WE-01 | Create with default config | Unit | P0 | maxParallel=3, timeout defaults set |
| WE-02 | Create with custom maxParallel | Unit | P1 | Custom value applied |
| WE-03 | Create without optional dependencies | Unit | P1 | Graceful fallback |

### 2.2 Wave Execution (`executeWaves()`)

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| WE-04 | Execute single wave with all tasks succeeding | Unit | P0 | All results success, metrics correct |
| WE-05 | Execute multiple waves sequentially | Unit | P0 | Each wave runs after previous completes |
| WE-06 | Execute with mixed success/failure results | Unit | P0 | Failed tasks tracked, execution continues |
| WE-07 | Execute with empty wave list | Unit | P1 | Returns empty results, no error |
| WE-08 | Events emitted: wave_started, wave_completed | Unit | P0 | Correct events with correct payload |

### 2.3 Single Wave Execution (`executeWave()`)

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| WE-09 | Execute wave respecting maxParallel limit | Unit | P0 | No more than maxParallel concurrent |
| WE-10 | Execute wave with task timeout | Unit | P0 | Timed-out task marked as failed |
| WE-11 | Execute wave with all tasks timing out | Unit | P1 | All marked failed, wave completes |
| WE-12 | Cancel in-progress wave | Unit | P1 | Pending tasks cancelled, running complete |

### 2.4 Utility Methods

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| WE-13 | `executeTaskWithTimeout` - success within timeout | Unit | P0 | Task result returned |
| WE-14 | `executeTaskWithTimeout` - exceeds timeout | Unit | P0 | Timeout error thrown |
| WE-15 | `chunkArray` - splits correctly | Unit | P1 | Arrays chunked by maxParallel |
| WE-16 | `chunkArray` - handles edge cases (empty, 1 item) | Unit | P2 | Correct output |
| WE-17 | `calculateMetrics` - computes correct stats | Unit | P1 | Success rate, duration, parallelism |
| WE-18 | `getStatus` - returns current execution state | Unit | P2 | Active tasks, progress info |

---

## 3. AutonomousBuildLoop (`autonomous-build-loop.js`) - P0

**Class:** `AutonomousBuildLoop extends EventEmitter`
**Key exports:** `AutonomousBuildLoop, BuildEvent, SubtaskResult, DEFAULT_CONFIG`
**Dependencies:** `BuildStateManager`, `RecoveryTracker` (optional), `WorktreeManager` (optional)

### 3.1 Constructor & Configuration

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| ABL-01 | Create with default config | Unit | P0 | maxIterations=10, globalTimeout=30min |
| ABL-02 | Create with custom config | Unit | P1 | Custom values override defaults |
| ABL-03 | Verify BuildEvent enum values | Unit | P2 | All events defined |
| ABL-04 | Verify SubtaskResult enum values | Unit | P2 | SUCCESS, FAILURE, SKIP, TIMEOUT |

### 3.2 Main Loop (`run()`, `executeLoop()`)

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| ABL-05 | Run with plan completing all subtasks | Integration | P0 | All subtasks complete, success returned |
| ABL-06 | Run with global timeout exceeded | Unit | P0 | Loop stops, timeout result returned |
| ABL-07 | Run with maxIterations reached | Unit | P0 | Loop stops, partial result returned |
| ABL-08 | Run with empty plan | Unit | P1 | Returns immediately with empty result |
| ABL-09 | Run emits correct events (loop_started, iteration_*, loop_completed) | Unit | P0 | All events in correct order |
| ABL-10 | `isTimedOut` returns true after timeout | Unit | P1 | Correct boolean based on elapsed time |
| ABL-11 | `isComplete` returns true when all subtasks done | Unit | P1 | Correct completion detection |

### 3.3 Subtask Execution

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| ABL-12 | `executeSubtaskWithRetry` - success on first try | Unit | P0 | Returns SUCCESS result |
| ABL-13 | `executeSubtaskWithRetry` - success on retry | Unit | P0 | Retries then succeeds |
| ABL-14 | `executeSubtaskWithRetry` - all retries fail | Unit | P0 | Returns FAILURE after max retries |
| ABL-15 | `executeSubtask` - delegates to Claude CLI | Unit | P1 | Correct prompt sent |
| ABL-16 | `executeSubtask` - handles CLI error | Unit | P1 | Error captured, not thrown |

### 3.4 Verification & Self-Critique

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| ABL-17 | `runVerification` - passes with clean output | Unit | P1 | Verification success |
| ABL-18 | `runVerification` - fails with lint errors | Unit | P1 | Verification failure with details |
| ABL-19 | `performSelfCritique` - identifies issues | Unit | P2 | Returns critique with suggestions |

### 3.5 Control Flow

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| ABL-20 | `pause()` - pauses execution loop | Unit | P1 | Loop waits, emits pause event |
| ABL-21 | `resume()` - resumes paused loop | Unit | P1 | Loop continues, emits resume event |
| ABL-22 | `stop()` - stops execution immediately | Unit | P1 | Loop exits, emits stop event |
| ABL-23 | `loadPlan()` - loads plan from file | Unit | P1 | Plan object returned |
| ABL-24 | `countSubtasks()` - counts from plan | Unit | P2 | Correct count |

---

## 4. SemanticMergeEngine (`semantic-merge-engine.js`) - P1

**Classes:** `SemanticAnalyzer`, `ConflictDetector`, `AutoMerger`, `AIResolver`, `CustomRulesLoader`, `SemanticMergeEngine`
**Enums:** `ChangeType` (18), `MergeStrategy` (5), `ConflictSeverity` (4), `MergeDecision` (4)
**Dependencies:** `git` CLI, `claude` CLI (for AI resolution), `js-yaml`

### 4.1 SemanticAnalyzer

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| SM-01 | `analyzeDiff` - parses standard git diff | Unit | P0 | Returns structured change objects |
| SM-02 | `extractElements` - extracts functions from JS | Unit | P0 | Function boundaries identified |
| SM-03 | `extractElements` - extracts classes from JS | Unit | P1 | Class boundaries identified |
| SM-04 | `computeChanges` - identifies added lines | Unit | P0 | ChangeType.ADD detected |
| SM-05 | `computeChanges` - identifies modified lines | Unit | P0 | ChangeType.MODIFY detected |
| SM-06 | `computeChanges` - identifies deleted lines | Unit | P0 | ChangeType.DELETE detected |
| SM-07 | `computeChanges` - identifies import changes | Unit | P1 | ChangeType.IMPORT detected |
| SM-08 | `getFileCategory` - categorizes .js files | Unit | P2 | Returns correct category |
| SM-09 | `getFileCategory` - categorizes .json files | Unit | P2 | Returns correct category |

### 4.2 ConflictDetector

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| SM-10 | `detectConflicts` - no overlapping changes | Unit | P0 | Empty conflicts array |
| SM-11 | `detectConflicts` - same function modified | Unit | P0 | Conflict with severity HIGH |
| SM-12 | `detectConflicts` - same line modified | Unit | P0 | Conflict with severity CRITICAL |
| SM-13 | `detectConflicts` - adjacent but not overlapping | Unit | P1 | No conflict detected |
| SM-14 | Severity assessment: import conflicts | Unit | P1 | LOW severity |
| SM-15 | Severity assessment: logic conflicts | Unit | P1 | HIGH severity |

### 4.3 AutoMerger

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| SM-16 | `tryAutoMerge` - non-overlapping changes | Unit | P0 | Merge succeeds automatically |
| SM-17 | `tryAutoMerge` - conflicting changes | Unit | P0 | Returns needs-manual flag |
| SM-18 | `combineImports` - merges import lists | Unit | P1 | Deduplicated imports |
| SM-19 | `combineImports` - handles conflicting imports | Unit | P1 | Both imports preserved |

### 4.4 CustomRulesLoader

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| SM-20 | Load rules from YAML file | Unit | P1 | Rules object returned |
| SM-21 | Load rules with missing file | Unit | P1 | Empty rules, no error |
| SM-22 | `matchesPattern` - glob matching | Unit | P2 | Correct match/no-match |
| SM-23 | `buildCompatibilityRules` - generates rules | Unit | P2 | Valid rules structure |

### 4.5 SemanticMergeEngine (Orchestrator)

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| SM-24 | `merge()` - full pipeline with no conflicts | Integration | P0 | Clean merge result |
| SM-25 | `merge()` - with auto-resolvable conflicts | Integration | P1 | Auto-merged successfully |
| SM-26 | `merge()` - with unresolvable conflicts | Integration | P1 | Returns conflicts for manual review |
| SM-27 | `merge()` - with custom rules applied | Unit | P2 | Rules affect merge behavior |
| SM-28 | MergeStrategy enum values verified | Unit | P2 | All strategies present |
| SM-29 | MergeDecision enum values verified | Unit | P2 | All decisions present |
| SM-30 | ChangeType enum - all 18 values present | Unit | P2 | Complete enum |
| SM-31 | ConflictSeverity enum values verified | Unit | P2 | All severities present |
| SM-32 | Error handling - invalid diff input | Unit | P1 | Graceful error, not crash |

---

## 5. ContextInjector (`context-injector.js`) - P1

**Class:** `ContextInjector`
**Key exports:** `ContextInjector`
**Dependencies:** `MemoryQuery` (optional), `GotchasMemory` (optional), `SessionMemory` (optional)

### 5.1 Constructor & Configuration

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| CI-01 | Create with default config | Unit | P0 | tokenBudget=4000, charsPerToken=4 |
| CI-02 | Create without memory dependencies | Unit | P0 | No errors, empty memory results |
| CI-03 | Create with injected dependencies | Unit | P1 | Dependencies used for queries |

### 5.2 Context Injection (`inject()`)

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| CI-04 | Inject for simple task | Unit | P0 | Returns formatted markdown string |
| CI-05 | Inject includes task description | Unit | P0 | Task ID and description present |
| CI-06 | Inject includes acceptance criteria | Unit | P1 | Numbered criteria in output |
| CI-07 | Inject includes relevant files | Unit | P1 | File paths with existence status |
| CI-08 | Inject respects token budget | Unit | P0 | Output length <= budget * charsPerToken |

### 5.3 File Inference

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| CI-09 | `inferFilesFromDescription` - backtick paths | Unit | P1 | Extracts paths in backticks |
| CI-10 | `inferFilesFromDescription` - quoted paths | Unit | P1 | Extracts paths in quotes |
| CI-11 | `inferFilesFromDescription` - no paths | Unit | P2 | Returns empty array |
| CI-12 | `inferFilesFromDescription` - deduplication | Unit | P2 | No duplicate paths |

### 5.4 Cache & Token Management

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| CI-13 | `trimToTokenBudget` - content under budget | Unit | P0 | Content unchanged |
| CI-14 | `trimToTokenBudget` - content over budget | Unit | P0 | Content trimmed by sections |
| CI-15 | Cache hit returns cached value | Unit | P1 | cacheHits metric incremented |
| CI-16 | Cache expires after TTL | Unit | P1 | Stale cache returns null |

---

## 6. ResultAggregator (`result-aggregator.js`) - P1

**Class:** `ResultAggregator extends EventEmitter`
**Key exports:** `ResultAggregator`

### 6.1 Single Wave Aggregation

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| RA-01 | Aggregate wave with all tasks successful | Unit | P0 | 100% success rate, no conflicts |
| RA-02 | Aggregate wave with mixed results | Unit | P0 | Correct success/failure counts |
| RA-03 | Aggregate wave with file conflicts | Unit | P0 | Conflicts detected and listed |
| RA-04 | Aggregate emits `aggregation_complete` event | Unit | P1 | Event with aggregation data |

### 6.2 Multi-Wave Aggregation

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| RA-05 | `aggregateAll` - combines multiple waves | Unit | P0 | Consolidated metrics correct |
| RA-06 | `aggregateAll` - cross-wave conflicts detected | Unit | P1 | All conflicts collected |

### 6.3 Conflict Detection

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| RA-07 | `detectFileConflicts` - no shared files | Unit | P0 | Empty conflicts |
| RA-08 | `detectFileConflicts` - same file modified by 2 tasks | Unit | P0 | One conflict entry |
| RA-09 | `assessConflictSeverity` - package.json | Unit | P1 | Returns 'critical' |
| RA-10 | `assessConflictSeverity` - config file | Unit | P1 | Returns 'high' |
| RA-11 | `assessConflictSeverity` - regular source file | Unit | P1 | Returns 'medium' |
| RA-12 | `suggestResolution` - JSON file | Unit | P2 | Suggests manual merge |
| RA-13 | `suggestResolution` - test file | Unit | P2 | Suggests auto merge |

### 6.4 Utility Methods

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| RA-14 | `extractFilesFromOutput` - multiple patterns | Unit | P1 | All file paths extracted |
| RA-15 | `extractFilesFromOutput` - empty output | Unit | P2 | Empty array |
| RA-16 | `summarizeOutput` - short output | Unit | P2 | Unchanged |
| RA-17 | `summarizeOutput` - long output (>500 chars) | Unit | P2 | Truncated with marker |
| RA-18 | `collectWarnings` - long duration task | Unit | P1 | Warning generated |
| RA-19 | `collectWarnings` - no files modified | Unit | P1 | Warning generated |
| RA-20 | `calculateMetrics` - correct parallel efficiency | Unit | P1 | wallTime vs totalDuration ratio |

---

## 7. RateLimitManager (`rate-limit-manager.js`) - P2

**Class:** `RateLimitManager extends EventEmitter`
**Key exports:** `RateLimitManager, withRateLimit, getGlobalManager`

### 7.1 Retry Logic

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| RL-01 | `executeWithRetry` - success on first attempt | Unit | P0 | Returns result, no retries |
| RL-02 | `executeWithRetry` - success after retry | Unit | P0 | Retries, then returns result |
| RL-03 | `executeWithRetry` - all retries exhausted | Unit | P0 | Throws after maxRetries |
| RL-04 | `executeWithRetry` - non-rate-limit error | Unit | P0 | Throws immediately, no retry |
| RL-05 | Metrics updated: totalRequests, rateLimitHits | Unit | P1 | Correct metric values |

### 7.2 Delay Calculation

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| RL-06 | `calculateDelay` - exponential backoff | Unit | P0 | 1s, 2s, 4s, 8s, 16s pattern |
| RL-07 | `calculateDelay` - respects maxDelay cap | Unit | P1 | Never exceeds maxDelay |
| RL-08 | `calculateDelay` - uses retryAfter from error | Unit | P1 | Uses error.retryAfter value |
| RL-09 | `calculateDelay` - parses retryAfter from message | Unit | P2 | Extracts from error message |

### 7.3 Rate Limit Detection

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| RL-10 | `isRateLimitError` - HTTP 429 status | Unit | P0 | Returns true |
| RL-11 | `isRateLimitError` - "rate limit" in message | Unit | P0 | Returns true |
| RL-12 | `isRateLimitError` - "overloaded" (Anthropic) | Unit | P1 | Returns true |
| RL-13 | `isRateLimitError` - regular error | Unit | P1 | Returns false |

### 7.4 Preemptive Throttling

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| RL-14 | `preemptiveThrottle` - below threshold | Unit | P1 | No delay applied |

---

## 8. ParallelMonitor (`parallel-monitor.js`) - P2

**Class:** `ParallelMonitor extends EventEmitter`
**Key exports:** `ParallelMonitor, getMonitor`

### 8.1 Wave Registration

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| PM-01 | `registerWave` - adds wave to activeWaves | Unit | P0 | Wave stored with correct data |
| PM-02 | `registerWave` - emits wave_registered event | Unit | P1 | Event emitted |

### 8.2 Task Lifecycle

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| PM-03 | `registerTaskStart` - adds task to activeTasks | Unit | P0 | Task stored, status='running' |
| PM-04 | `registerTaskStart` - updates wave task status | Unit | P1 | Wave task status='running' |
| PM-05 | `addTaskOutput` - appends to task logs | Unit | P1 | Log entry added with timestamp |
| PM-06 | `addTaskOutput` - trims when exceeding maxLogLines | Unit | P2 | Oldest entries removed |
| PM-07 | `registerTaskComplete` - success | Unit | P0 | Task status='completed', duration set |
| PM-08 | `registerTaskComplete` - failure | Unit | P0 | Task status='failed', emits task_failed |
| PM-09 | `registerTaskComplete` - adds to history | Unit | P1 | History entry created |
| PM-10 | `registerTaskComplete` - history bounded | Unit | P2 | Oldest removed when > maxHistory |

### 8.3 Wave Completion & Status

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| PM-11 | `registerWaveComplete` - success | Unit | P0 | Wave status='completed' |
| PM-12 | `cancelWave` - marks pending/running as cancelled | Unit | P1 | All non-complete tasks cancelled |
| PM-13 | `getStatus` - returns active waves summary | Unit | P1 | Progress counts correct |
| PM-14 | `getTaskLogs` - returns logs for specific task | Unit | P2 | Correct logs returned |

### 8.4 Formatting & Utilities

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| PM-15 | `formatProgressBar` - partial progress | Unit | P2 | ASCII bar correct |
| PM-16 | `formatStatus` - formatted CLI output | Unit | P2 | Contains wave info |

---

## 9. SubagentDispatcher (`subagent-dispatcher.js`) - P2

**Class:** `SubagentDispatcher extends EventEmitter`
**Key exports:** `SubagentDispatcher`
**Dependencies:** `MemoryQuery` (optional), `GotchasMemory` (optional), `child_process.spawn`

### 9.1 Agent Resolution

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| SD-01 | `resolveAgent` - explicit agent in task | Unit | P0 | Returns task.agent |
| SD-02 | `resolveAgent` - by task type 'database' | Unit | P0 | Returns '@data-engineer' |
| SD-03 | `resolveAgent` - by task type 'test' | Unit | P0 | Returns '@qa' |
| SD-04 | `resolveAgent` - by task tags | Unit | P1 | Matches first tag |
| SD-05 | `resolveAgent` - by description inference | Unit | P1 | Matches keyword patterns |
| SD-06 | `resolveAgent` - default fallback | Unit | P0 | Returns '@dev' |
| SD-07 | `resolveAgent` - adds @ prefix if missing | Unit | P2 | '@' prepended |

### 9.2 Dispatch Flow

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| SD-08 | `dispatch` - successful execution | Unit | P0 | Returns success result with output |
| SD-09 | `dispatch` - failure with retry and recovery | Unit | P0 | Retries, then succeeds |
| SD-10 | `dispatch` - all retries fail | Unit | P0 | Returns failure result |
| SD-11 | `dispatch` - emits dispatch_started/completed events | Unit | P1 | Events emitted in order |
| SD-12 | `dispatch` - enriches context before execution | Unit | P1 | Context includes memory/gotchas |

### 9.3 Context Enrichment

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| SD-13 | `enrichContext` - adds memory context | Unit | P1 | Memory data merged |
| SD-14 | `enrichContext` - adds gotchas | Unit | P1 | Relevant gotchas included |
| SD-15 | `enrichContext` - handles memory query failure | Unit | P1 | Continues without memory |
| SD-16 | `isRelevantGotcha` - pattern match | Unit | P2 | Returns true for matching pattern |
| SD-17 | `isRelevantGotcha` - keyword overlap | Unit | P2 | Returns true for 2+ keyword overlap |
| SD-18 | `isRelevantGotcha` - no relevance | Unit | P2 | Returns false |

### 9.4 Prompt Building & Execution

| ID | Scenario | Level | Priority | Expected |
|----|----------|-------|----------|----------|
| SD-19 | `buildPrompt` - includes agent ID and task | Unit | P1 | Prompt has agent and task sections |
| SD-20 | `buildPrompt` - includes acceptance criteria | Unit | P2 | Criteria listed |
| SD-21 | `extractModifiedFiles` - parses output | Unit | P1 | File paths extracted |
| SD-22 | `extractModifiedFiles` - empty output | Unit | P2 | Empty array |

---

## Test Infrastructure Notes

### Mock Strategy

All execution modules depend on external systems (file system, Claude CLI, git). The following mock strategy applies:

| Dependency | Mock Approach |
|------------|---------------|
| `fs` / file system | Use `os.tmpdir()` + `fs.mkdtempSync()` (pattern from existing build-state-manager tests) |
| `child_process.spawn` | Jest `jest.mock('child_process')` with configurable stdout/stderr/exit code |
| `BuildStateManager` | Already tested; use real instances with temp dirs |
| `MemoryQuery`, `GotchasMemory`, `SessionMemory` | Inject mock objects via constructor config |
| `WorktreeManager` | Inject mock or omit (optional dependency) |
| `EventEmitter` events | Use `jest.fn()` listeners to verify event emissions |

### Shared Test Utilities

Create `tests/core/execution-test-helpers.js` with:
- `createTempDir()` / `cleanupTempDir()` helpers
- `mockChildProcess(stdout, stderr, exitCode)` factory
- `createMockTask(overrides)` factory
- `createMockWaveResults(taskCount, successRate)` factory
- `createMockMemoryQuery()` and `createMockGotchasMemory()` factories

### Test Execution Order

Due to file system dependencies, tests should use unique temp directories per test (pattern from existing tests) and clean up in `afterEach`.

---

## Quality Gate

```yaml
gate:
  name: execution-system-coverage
  type: test-coverage
  threshold:
    global: 50
    core-execution: 70
  required_files:
    - tests/core/build-orchestrator.test.js
    - tests/core/wave-executor.test.js
    - tests/core/autonomous-build-loop.test.js
    - tests/core/semantic-merge-engine.test.js
    - tests/core/context-injector.test.js
    - tests/core/result-aggregator.test.js
    - tests/core/rate-limit-manager.test.js
    - tests/core/parallel-monitor.test.js
    - tests/core/subagent-dispatcher.test.js
  pass_criteria:
    - All P0 scenarios pass
    - No regressions in build-state-manager.test.js
    - Coverage for execution/ >= 70%
```

---

## Implementation Priority

### Sprint 1 - Critical Path (P0)

Focus on the three orchestration files that control the entire build pipeline:

1. **`wave-executor.test.js`** - Start here: smallest P0 file, pure execution logic
2. **`build-orchestrator.test.js`** - Core pipeline, depends on wave-executor understanding
3. **`autonomous-build-loop.test.js`** - Autonomous execution, highest complexity

**Target:** 70 scenarios, covering all P0 cases for these 3 files.

### Sprint 2 - Analysis & Merge (P1)

4. **`semantic-merge-engine.test.js`** - Highly testable pure logic, many unit tests possible
5. **`context-injector.test.js`** - Context building, mostly string manipulation
6. **`result-aggregator.test.js`** - Result processing, conflict detection

**Target:** 68 scenarios, covering all P0 + P1 cases for these 3 files.

### Sprint 3 - Infrastructure (P2)

7. **`rate-limit-manager.test.js`** - Retry logic, delay calculation
8. **`parallel-monitor.test.js`** - Monitoring and status tracking
9. **`subagent-dispatcher.test.js`** - Agent resolution and dispatch

**Target:** 52 scenarios, full coverage for remaining files.

---

## Traceability

| Source | Test Design | Story |
|--------|-------------|-------|
| `build-orchestrator.js` | BO-01 to BO-28 | Story 8.4 |
| `wave-executor.js` | WE-01 to WE-18 | Story 10.4 |
| `autonomous-build-loop.js` | ABL-01 to ABL-24 | Story 8.4 |
| `build-state-manager.js` | (existing 38 tests) | Story 8.4 |
| `semantic-merge-engine.js` | SM-01 to SM-32 | Story 10.7 |
| `context-injector.js` | CI-01 to CI-16 | Story 10.3 |
| `result-aggregator.js` | RA-01 to RA-20 | Story 10.5 |
| `rate-limit-manager.js` | RL-01 to RL-14 | Story 11.3 |
| `parallel-monitor.js` | PM-01 to PM-16 | Story 10.6 |
| `subagent-dispatcher.js` | SD-01 to SD-22 | Story 10.2 |

---

## Coverage Projection

| Phase | Files Covered | New Tests | Est. Coverage |
|-------|---------------|-----------|---------------|
| Baseline | 1/10 | 38 | ~10% |
| After Sprint 1 | 4/10 | +70 = 108 | ~45% |
| After Sprint 2 | 7/10 | +68 = 176 | ~75% |
| After Sprint 3 | 10/10 | +52 = 228 | ~90% |

---

*Generated by @qa (Quinn) - Synkra AIOS Test Design*
