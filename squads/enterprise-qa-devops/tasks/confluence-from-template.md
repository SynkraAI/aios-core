# Task: Create Confluence Page from Template

## Metadata
```yaml
id: confluence-from-template
name: Create Page from Template
agent: confluence-agent
version: 1.0.0
```

## Description

Creates a new Confluence page from a predefined template with variable substitution.

## Input Schema

```typescript
interface ConfluenceFromTemplateInput {
  template: string;          // Required: Template ID or name
  space: string;             // Required: Target space key
  title: string;             // Required: New page title
  parent?: string;           // Optional: Parent page title or ID
  variables: Record<string, any>; // Required: Template variables
  labels?: string[];         // Optional: Additional labels
}
```

## Output Schema

```typescript
interface ConfluenceFromTemplateOutput {
  success: boolean;
  pageId: string;
  title: string;
  url: string;
  version: number;
  templateUsed: string;
}
```

## Implementation

```javascript
async function createFromTemplate(input) {
  const { ConfluenceClient } = require('../tools/confluence-client');
  const fs = require('fs');
  const path = require('path');
  const client = new ConfluenceClient();

  // Load template
  let templateContent;

  // Check for built-in templates first
  const builtInPath = path.join(__dirname, '../templates', `${input.template}.md`);
  if (fs.existsSync(builtInPath)) {
    templateContent = fs.readFileSync(builtInPath, 'utf-8');
  } else {
    // Try to get from Confluence
    const template = await client.getTemplate(input.template);
    templateContent = template.body.storage.value;
  }

  // Variable substitution
  let content = templateContent;
  for (const [key, value] of Object.entries(input.variables)) {
    const regex = new RegExp(`\\$\\{${key}\\}`, 'g');

    // Handle different value types
    let replacement;
    if (Array.isArray(value)) {
      replacement = value.map(v => `<li>${v}</li>`).join('\n');
    } else if (typeof value === 'object') {
      replacement = formatObjectAsTable(value);
    } else {
      replacement = String(value);
    }

    content = content.replace(regex, replacement);
  }

  // Convert markdown to Confluence storage format if needed
  if (builtInPath) {
    content = markdownToConfluence(content);
  }

  // Create page with processed content
  const pagePayload = {
    type: 'page',
    title: input.title,
    space: { key: input.space },
    body: {
      storage: {
        value: content,
        representation: 'storage'
      }
    }
  };

  // Add parent if specified
  if (input.parent) {
    const parentPage = await client.findPage(input.space, input.parent);
    pagePayload.ancestors = [{ id: parentPage.id }];
  }

  // Create the page
  const response = await client.createContent(pagePayload);

  // Add labels
  const allLabels = [...(input.labels || []), input.template];
  await client.addLabels(response.id, allLabels);

  return {
    success: true,
    pageId: response.id,
    title: response.title,
    url: `${process.env.ATLASSIAN_DOMAIN}/wiki${response._links.webui}`,
    version: response.version.number,
    templateUsed: input.template
  };
}

function formatObjectAsTable(obj) {
  let html = '<table><tbody>';
  for (const [key, value] of Object.entries(obj)) {
    html += `<tr><td><strong>${key}</strong></td><td>${value}</td></tr>`;
  }
  html += '</tbody></table>';
  return html;
}

function markdownToConfluence(md) {
  // Basic markdown to Confluence conversion
  let html = md;

  // Headers
  html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
  html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');

  // Bold and italic
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');

  // Lists
  html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
  html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');

  // Code
  html = html.replace(/`(.+?)`/g, '<code>$1</code>');

  // Paragraphs
  html = html.replace(/^(?!<[hul]|<li)(.+)$/gm, '<p>$1</p>');

  return html;
}

module.exports = { createFromTemplate };
```

## Built-in Templates

### test-report-template
```markdown
# ${title}

**Date:** ${date}
**Version:** ${version}
**Test Plan:** ${test_plan}

## Summary

| Metric | Value |
|--------|-------|
| Total Tests | ${total} |
| Passed | ${passed} |
| Failed | ${failed} |
| Pass Rate | ${pass_rate}% |
| Duration | ${duration} |

## Status

${status_badge}

## Failed Tests

${failed_tests}

## Links

- [Test Execution](${execution_url})
- [Jira Filter](${jira_url})

---
*Generated by AIOS Enterprise QA DevOps Squad*
```

### bug-report-template
```markdown
# ${title}

## Overview

**Severity:** ${severity}
**Priority:** ${priority}
**Component:** ${component}
**Found In:** ${version}

## Description

${description}

## Steps to Reproduce

${steps}

## Expected Result

${expected}

## Actual Result

${actual}

## Environment

${environment}

## Attachments

${attachments}
```

### sprint-summary-template
```markdown
# ${sprint_name} Summary

**Duration:** ${start_date} - ${end_date}
**Team:** ${team}

## Velocity

| Metric | Planned | Actual |
|--------|---------|--------|
| Story Points | ${planned_points} | ${actual_points} |
| Stories | ${planned_stories} | ${completed_stories} |

## Highlights

${highlights}

## Issues

${issues}

## Action Items

${action_items}
```

## Usage Examples

### Test Report
```bash
@confluence *from-template \
  --template test-report-template \
  --space QA \
  --title "Sprint 15 Test Report - 2026-02-04" \
  --parent "Test Reports" \
  --variables '{
    "title": "Sprint 15 Test Report",
    "date": "2026-02-04",
    "version": "1.2.0",
    "test_plan": "PROJ-100",
    "total": 142,
    "passed": 139,
    "failed": 3,
    "pass_rate": 97.9,
    "duration": "45m 23s",
    "status_badge": "âœ… PASSED",
    "failed_tests": "- test_login_timeout\n- test_export_pdf\n- test_bulk_delete",
    "execution_url": "https://jira.company.com/browse/PROJ-EXEC-456",
    "jira_url": "https://jira.company.com/issues/?filter=12345"
  }' \
  --labels "sprint-15,automated"
```

### Bug Report
```bash
@confluence *from-template \
  --template bug-report-template \
  --space QA \
  --title "BUG: Login timeout on slow connections" \
  --variables '{
    "title": "Login Timeout Bug",
    "severity": "High",
    "priority": "P1",
    "component": "Authentication",
    "version": "1.2.0-RC1",
    "description": "Users on slow connections experience timeout during login",
    "steps": "1. Throttle connection to 3G\n2. Navigate to login\n3. Enter credentials\n4. Click Login",
    "expected": "Login completes within 10 seconds",
    "actual": "Request times out after 5 seconds",
    "environment": "iOS Safari 17, 3G connection",
    "attachments": "See attached HAR file"
  }'
```

### Sprint Summary
```bash
@confluence *from-template \
  --template sprint-summary-template \
  --space TEAM \
  --title "Sprint 15 Summary" \
  --parent "Sprint Summaries" \
  --variables '{
    "sprint_name": "Sprint 15",
    "start_date": "2026-01-20",
    "end_date": "2026-02-03",
    "team": "Platform Team",
    "planned_points": 34,
    "actual_points": 31,
    "planned_stories": 12,
    "completed_stories": 10,
    "highlights": "- Completed OAuth 2.0 integration\n- Improved test coverage to 85%",
    "issues": "- PROJ-123 blocked by external dependency\n- PROJ-145 rolled over to Sprint 16",
    "action_items": "- Schedule dependency review meeting\n- Update CI pipeline for new tests"
  }'
```

## Output Example

```json
{
  "success": true,
  "pageId": "12345678",
  "title": "Sprint 15 Test Report - 2026-02-04",
  "url": "https://company.atlassian.net/wiki/spaces/QA/pages/12345678",
  "version": 1,
  "templateUsed": "test-report-template"
}
```

## Error Handling

| Error Code | Description | Resolution |
|------------|-------------|------------|
| TEMPLATE_NOT_FOUND | Template doesn't exist | Check template name |
| MISSING_VARIABLE | Required variable missing | Provide all variables |
| 401 | Authentication failed | Check API token |
| 409 | Page already exists | Use different title |

## Related Tasks

- `confluence-create-page` - Create without template
- `confluence-update-page` - Update templated pages
- `xray-coverage-report` - Generate data for templates
