{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://synkra.ai/schemas/session-state.json",
  "title": "AIOS Session State",
  "description": "Schema for AIOS Bob Orchestrator session state persistence (Story 11.5, ADR-011)",
  "type": "object",
  "required": ["session_state"],
  "additionalProperties": false,
  "properties": {
    "session_state": {
      "type": "object",
      "required": [
        "version",
        "last_updated",
        "epic",
        "progress",
        "workflow",
        "last_action",
        "context_snapshot",
        "resume_instructions"
      ],
      "additionalProperties": false,
      "properties": {
        "version": {
          "type": "string",
          "description": "Session state schema version",
          "pattern": "^\\d+\\.\\d+$",
          "examples": ["1.2"]
        },
        "last_updated": {
          "type": "string",
          "description": "ISO 8601 timestamp of last update",
          "format": "date-time",
          "examples": ["2026-02-14T10:30:00.000Z"]
        },
        "epic": {
          "type": "object",
          "description": "Epic context (AC2 - Story 11.5)",
          "required": ["id", "title", "total_stories"],
          "additionalProperties": false,
          "properties": {
            "id": {
              "type": "string",
              "description": "Epic identifier",
              "minLength": 1,
              "examples": ["epic-bob-refinement", "migrated"]
            },
            "title": {
              "type": "string",
              "description": "Epic human-readable title",
              "minLength": 1,
              "examples": ["Magic Bob Refinement", "Migrated from Workflow State"]
            },
            "total_stories": {
              "type": "integer",
              "description": "Total number of stories in epic",
              "minimum": 0,
              "examples": [5, 10, 1]
            }
          }
        },
        "progress": {
          "type": "object",
          "description": "Progress tracking (AC3 - Story 11.5)",
          "required": ["current_story", "stories_done", "stories_pending"],
          "additionalProperties": false,
          "properties": {
            "current_story": {
              "description": "Current story being worked on (null if none)",
              "oneOf": [
                {
                  "type": "string",
                  "minLength": 1,
                  "examples": ["BOB-P0-1-VAL", "story-6.1.4"]
                },
                {
                  "type": "null"
                }
              ]
            },
            "stories_done": {
              "type": "array",
              "description": "Array of completed story IDs",
              "items": {
                "type": "string",
                "minLength": 1
              },
              "uniqueItems": true,
              "examples": [["BOB-P0-1-VAL", "BOB-P0-2-VAL"]]
            },
            "stories_pending": {
              "type": "array",
              "description": "Array of pending story IDs",
              "items": {
                "type": "string",
                "minLength": 1
              },
              "uniqueItems": true,
              "examples": [["BOB-P0-3-VAL", "BOB-P0-4-VAL"]]
            }
          }
        },
        "workflow": {
          "type": "object",
          "description": "Workflow state (ADR-011 - migrated from Story 11.3)",
          "required": ["current_phase", "attempt_count", "phase_results", "started_at"],
          "additionalProperties": false,
          "properties": {
            "current_phase": {
              "description": "Current phase of 6-phase pipeline (null if none)",
              "oneOf": [
                {
                  "type": "string",
                  "enum": ["validation", "development", "self_healing", "quality_gate", "push", "checkpoint"]
                },
                {
                  "type": "null"
                }
              ]
            },
            "attempt_count": {
              "type": "integer",
              "description": "Number of attempts for current phase",
              "minimum": 0,
              "default": 0
            },
            "phase_results": {
              "type": "object",
              "description": "Results from each phase execution",
              "additionalProperties": {
                "type": "object"
              },
              "examples": [
                {
                  "validation": {"status": "PASS", "duration": 2345},
                  "development": {"status": "PASS", "executor": "dev"}
                }
              ]
            },
            "started_at": {
              "type": "string",
              "description": "ISO 8601 timestamp when workflow started",
              "format": "date-time",
              "examples": ["2026-02-14T09:00:00.000Z"]
            }
          }
        },
        "last_action": {
          "type": "object",
          "description": "Last action recorded (AC4 - Story 11.5)",
          "required": ["type", "timestamp", "story", "phase"],
          "additionalProperties": false,
          "properties": {
            "type": {
              "type": "string",
              "description": "Action type",
              "enum": [
                "GO",
                "PAUSE",
                "REVIEW",
                "ABORT",
                "PHASE_CHANGE",
                "EPIC_STARTED",
                "STORY_STARTED",
                "STORY_COMPLETED",
                "CHECKPOINT_REACHED",
                "ERROR_OCCURRED"
              ]
            },
            "timestamp": {
              "type": "string",
              "description": "ISO 8601 timestamp of action",
              "format": "date-time",
              "examples": ["2026-02-14T10:30:00.000Z"]
            },
            "story": {
              "description": "Story ID for action (null if not story-specific)",
              "oneOf": [
                {
                  "type": "string",
                  "minLength": 1
                },
                {
                  "type": "null"
                }
              ]
            },
            "phase": {
              "description": "Phase for action (null if not phase-specific)",
              "oneOf": [
                {
                  "type": "string",
                  "enum": ["validation", "development", "self_healing", "quality_gate", "push", "checkpoint"]
                },
                {
                  "type": "null"
                }
              ]
            }
          }
        },
        "context_snapshot": {
          "type": "object",
          "description": "Context snapshot (AC5 - Story 11.5)",
          "required": ["files_modified", "executor_distribution", "last_executor", "branch"],
          "additionalProperties": false,
          "properties": {
            "files_modified": {
              "type": "integer",
              "description": "Number of files modified in session",
              "minimum": 0,
              "default": 0
            },
            "executor_distribution": {
              "type": "object",
              "description": "Count of executions per executor agent",
              "additionalProperties": {
                "type": "integer",
                "minimum": 0
              },
              "examples": [
                {
                  "dev": 5,
                  "qa": 3,
                  "devops": 1
                }
              ]
            },
            "last_executor": {
              "description": "Last executor agent used (null if none)",
              "oneOf": [
                {
                  "type": "string",
                  "minLength": 1,
                  "examples": ["dev", "qa", "devops", "architect"]
                },
                {
                  "type": "null"
                }
              ]
            },
            "branch": {
              "type": "string",
              "description": "Git branch for session",
              "minLength": 1,
              "examples": ["main", "feat/bob-refinement", "fix/validation"]
            }
          }
        },
        "resume_instructions": {
          "type": "string",
          "description": "Human-readable resume instructions (auto-generated)",
          "minLength": 1,
          "examples": [
            "Story BOB-P0-1-VAL estava em fase de validation.\ndev estava trabalhando no desenvolvimento.\nProgresso: 0 de 4 stories completas.\nPróximo passo: continuar implementação ou revisar o que foi feito."
          ]
        },
        "overrides": {
          "type": "object",
          "description": "Session-level overrides (Story 12.7 - AC6)",
          "additionalProperties": false,
          "properties": {
            "educational_mode": {
              "description": "Session override for educational mode (null = not overridden)",
              "oneOf": [
                {
                  "type": "boolean"
                },
                {
                  "type": "null"
                }
              ]
            }
          }
        }
      }
    }
  }
}
